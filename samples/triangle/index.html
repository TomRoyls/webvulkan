<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WebVulkan Triangle</title>
    <style>
        body { margin: 0; background: #1a1a2e; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: system-ui; }
        canvas { border: 2px solid #4a4a6a; background: #0f0f1a; }
        #status { position: fixed; top: 10px; left: 10px; color: #8a8aaa; font-size: 14px; }
        #error { position: fixed; top: 10px; left: 10px; color: #ff6b6b; font-size: 14px; display: none; max-width: 80%; }
    </style>
</head>
<body>
    <div id="status">Initializing WebGPU...</div>
    <div id="error"></div>
    <canvas id="canvas" width="800" height="600"></canvas>

    <script>
        async function initWebGPU() {
            if (!navigator.gpu) {
                throw new Error('WebGPU not supported. Please use Chrome 113+ or Edge 113+');
            }

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                throw new Error('Failed to get GPU adapter');
            }

            const device = await adapter.requestDevice();
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('webgpu');
            
            const format = navigator.gpu.getPreferredCanvasFormat();
            context.configure({
                device: device,
                format: format,
                alphaMode: 'opaque',
            });

            return { device, context, format, canvas };
        }

        async function main() {
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');

            try {
                const { device, context, format, canvas } = await initWebGPU();
                statusEl.textContent = 'WebGPU initialized. Loading WASM...';

                const module = await WebAssembly.instantiateStreaming(
                    fetch('triangle.wasm'),
                    {
                        env: {
                            memory: new WebAssembly.Memory({ initial: 256, maximum: 256 }),
                        },
                        webgpu: {
                            wgpuDeviceCreateBuffer: (device, desc) => {
                                console.log('wgpuDeviceCreateBuffer called');
                                return 0;
                            },
                        },
                    }
                );

                statusEl.textContent = 'WASM loaded. Running...';
                
                if (module.instance.exports.main) {
                    module.instance.exports.main();
                }

                statusEl.textContent = 'Triangle complete!';

            } catch (e) {
                console.error(e);
                statusEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Error: ' + e.message;
            }
        }

        window.addEventListener('load', main);
    </script>
</body>
</html>
